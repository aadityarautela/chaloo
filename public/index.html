  <!DOCTYPE html>
  <html>

  <head>
    <title>AI Planner Test UI</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2em;
        background-color: #f4f4f9;
      }

      .container {
        max-width: 800px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h2 {
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        color: #333;
      }

      .function-test {
        margin-bottom: 30px;
      }

      input[type="text"] {
        width: 70%;
        padding: 8px;
        margin-right: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      button {
        padding: 8px 15px;
        border: none;
        background-color: #007bff;
        color: white;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background-color: #0056b3;
      }

      button:disabled {
        background-color: #ccc;
      }

      pre {
        background-color: #eee;
        padding: 15px;
        border-radius: 4px;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      #chat-window {
        height: 300px;
        border: 1px solid #ccc;
        overflow-y: scroll;
        padding: 10px;
        margin-bottom: 10px;
        background: #fafafa;
      }

      .user-message {
        text-align: right;
        margin: 5px;
      }

      .model-message {
        text-align: left;
        margin: 5px;
      }
    </style>
  </head>

  <body>

    <div class="container">
      <h1>Firebase AI Planner Test UI</h1>

      <!-- Test for generate_itinerary -->
      <div class="function-test">
        <h2>Test 1: Generate New Itinerary (Stateless)</h2>
        <input type="text" id="destination-input" placeholder="Enter a destination (e.g., Tokyo)">
        <button id="generate-btn">Generate</button>
        <h3>Result:</h3>
        <pre id="itinerary-result">...</pre>
      </div>

      <!-- Test for gen_itinerary_chat -->
      <div class="function-test">
        <h2>Test 2: Itinerary Chat (Stateful)</h2>
        <div id="chat-window"></div>
        <input type="text" id="chat-input" placeholder="Ask for an itinerary or make a change">
        <button id="chat-btn">Send</button>
        <h3>Full Conversation History (for debugging):</h3>
        <pre id="chat-history-result">[]</pre>
      </div>
    </div>

    <!-- Import Firebase SDKs -->
    <!-- You MUST use version 9+ for this to work -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getFunctions, httpsCallable, connectFunctionsEmulator } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-functions.js";

      // --- IMPORTANT: CONFIGURE FIREBASE HERE ---
      // Replace with your project's actual configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyBAUN3emcbA8cIVQSjyF7Pn53GDmCxJFmU",
        authDomain: "ai-planner-backend-qwerty.firebaseapp.com",
        databaseURL: "https://ai-planner-backend-qwerty-default-rtdb.firebaseio.com",
        projectId: "ai-planner-backend-qwerty",
        storageBucket: "ai-planner-backend-qwerty.firebasestorage.app",
        messagingSenderId: "644764444038",
        appId: "1:644764444038:web:b912054b03d5c46c133807",
        measurementId: "G-QL7EZ77V9H"
      };
      // You can find this config in your Firebase project settings -> General tab

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const functions = getFunctions(app);

      // --- THIS IS THE KEY FOR LOCAL TESTING ---
      // Point the SDK to your local Functions emulator
      // connectFunctionsEmulator(functions, "localhost", 5001);

      // --- Logic for Test 1: generate_itinerary ---
      const destinationInput = document.getElementById('destination-input');
      const generateBtn = document.getElementById('generate-btn');
      const itineraryResult = document.getElementById('itinerary-result');

      generateBtn.addEventListener('click', async () => {
        const destination = destinationInput.value;
        if (!destination) {
          alert('Please enter a destination.');
          return;
        }

        itineraryResult.textContent = 'Generating...';
        generateBtn.disabled = true;

        const generateItinerary = httpsCallable(functions, 'generate_itinerary');
        try {
          const result = await generateItinerary({ destination: destination });
          itineraryResult.textContent = result.data.itinerary;
        } catch (error) {
          console.error("Error calling generate_itinerary:", error);
          itineraryResult.textContent = `Error: ${error.message}`;
        } finally {
          generateBtn.disabled = false;
        }
      });


      // --- Logic for Test 2: gen_itinerary_chat ---
      const chatInput = document.getElementById('chat-input');
      const chatBtn = document.getElementById('chat-btn');
      const chatWindow = document.getElementById('chat-window');
      const chatHistoryResult = document.getElementById('chat-history-result');

      let conversationHistory = []; // This is where the client stores the state

      chatBtn.addEventListener('click', async () => {
        const prompt = chatInput.value;
        if (!prompt) return;

        // Display user message immediately
        addMessageToChatWindow(prompt, 'user-message');
        chatInput.value = ''; // Clear input
        chatBtn.disabled = true;

        const genItineraryChat = httpsCallable(functions, 'gen_itinerary_chat');
        try {
          const result = await genItineraryChat({
            prompt: prompt,
            history: conversationHistory
          });

          // Update our local history with the one from the server
          conversationHistory = result.data.history;

          // Display the model's response
          const modelResponse = result.data.response;
          addMessageToChatWindow(modelResponse, 'model-message');

          // Update the debug view
          chatHistoryResult.textContent = JSON.stringify(conversationHistory, null, 2);

        } catch (error) {
          console.error("Error calling gen_itinerary_chat:", error);
          addMessageToChatWindow(`Error: ${error.message}`, 'model-message');
        } finally {
          chatBtn.disabled = false;
        }``
      });

      function addMessageToChatWindow(text, className) {
        const messageDiv = document.createElement('div');
        messageDiv.className = className;
        messageDiv.textContent = text;
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll
      }

    </script>
  </body>

  </html>